name: "Copilot Setup Steps"

# Automatically run the setup steps when they are changed to allow for easy validation
on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Install Japanese fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
          fc-cache -fv

      - name: Install PC/SC libraries
        run: |
          sudo apt-get install -y pcscd libpcsclite-dev

      - name: Setup Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: "22"

      - name: Cache npm dependencies
        uses: actions/cache@v4.3.0
        with:
          path: |
            ~/.npm
            node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Cache local-packages (jsapdu builds)
        uses: actions/cache@v4.3.0
        with:
          path: local-packages
          key: ${{ runner.os }}-jsapdu-packages-v1
          restore-keys: |
            ${{ runner.os }}-jsapdu-packages-

      - name: Cache Turbo
        uses: actions/cache@v4.3.0
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Cache VOICEVOX Core
        uses: actions/cache@v4.3.0
        with:
          path: voicevox_core
          key: ${{ runner.os }}-voicevox-core-v1
          restore-keys: |
            ${{ runner.os }}-voicevox-core-

      - name: Install dependencies
        run: npm install

      - name: Build all packages
        run: npm run build
