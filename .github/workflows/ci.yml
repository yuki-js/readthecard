name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Install Japanese fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
          fc-cache -fv

      - name: Install PC/SC libraries
        run: |
          sudo apt-get install -y pcscd libpcsclite-dev

      - name: Setup Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: "22"

      - name: Cache npm dependencies
        uses: actions/cache@v4.3.0
        with:
          path: |
            ~/.npm
            node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Cache local-packages (jsapdu builds)
        uses: actions/cache@v4.3.0
        with:
          path: local-packages
          key: ${{ runner.os }}-jsapdu-packages-v1
          restore-keys: |
            ${{ runner.os }}-jsapdu-packages-

      - name: Cache Turbo
        uses: actions/cache@v4.3.0
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Cache VOICEVOX Core
        uses: actions/cache@v4.3.0
        with:
          path: |
            voicevox_core
          key: ${{ runner.os }}-voicevox-core-0.16.2
          restore-keys: |
            ${{ runner.os }}-voicevox-core-

      - name: Download VOICEVOX Core
        run: |
          if [ ! -d "voicevox_core" ]; then
            curl -sSfL https://github.com/VOICEVOX/voicevox_core/releases/download/0.16.2/voicevox_core-linux-x64-0.16.2.zip -o voicevox_core.zip
            unzip -q voicevox_core.zip -d voicevox_core_tmp
            mv voicevox_core_tmp/* voicevox_core
            rm -rf voicevox_core_tmp voicevox_core.zip
          fi

      - name: Install dependencies
        run: npm install

      - name: Build all packages
        run: npm run build

      - name: Typecheck
        run: npm run typecheck
