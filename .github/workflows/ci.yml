name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@v4.1.0
        with:
          node-version: "22"

      - name: Cache npm dependencies
        uses: actions/cache@v4.2.0
        with:
          path: |
            ~/.npm
            node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Cache jsapdu build
        uses: actions/cache@v4.2.0
        with:
          path: |
            packages/jsapdu/packages/*/dist
            packages/jsapdu/packages/*/node_modules
          key: ${{ runner.os }}-jsapdu-${{ hashFiles('packages/jsapdu/**/*.ts', 'packages/jsapdu/**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-jsapdu-

      - name: Cache Turbo
        uses: actions/cache@v4.2.0
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Cache VOICEVOX Core
        uses: actions/cache@v4.2.0
        with:
          path: |
            voicevox_core
          key: ${{ runner.os }}-voicevox-core-0.16.0
          restore-keys: |
            ${{ runner.os }}-voicevox-core-

      - name: Clone jsapdu
        run: |
          if [ ! -d "packages/jsapdu" ]; then
            git clone --depth=1 --branch dev https://github.com/AokiApp/jsapdu.git packages/jsapdu
          fi

      - name: Build jsapdu packages
        run: |
          cd packages/jsapdu/packages/interface && npm install && npm run build
          cd ../apdu-utils && npm install && npm run build
          cd ../mynacard && npm install && npm run build
          cd ../pcsc-ffi-node && npm install && npm run build
          cd ../pcsc && npm install && npm run build

      - name: Pack jsapdu packages
        run: |
          mkdir -p local-packages
          cd packages/jsapdu/packages/interface && npm pack && mv *.tgz ../../../../local-packages/
          cd ../apdu-utils && npm pack && mv *.tgz ../../../../local-packages/
          cd ../mynacard && npm pack && mv *.tgz ../../../../local-packages/
          cd ../pcsc-ffi-node && npm pack && mv *.tgz ../../../../local-packages/
          cd ../pcsc && npm pack && mv *.tgz ../../../../local-packages/

      - name: Download VOICEVOX Core
        run: |
          if [ ! -d "voicevox_core" ]; then
            curl -sSfL https://github.com/VOICEVOX/voicevox_core/releases/download/0.16.0/voicevox_core-linux-x64-cpu-0.16.0.zip -o voicevox_core.zip
            unzip -q voicevox_core.zip -d voicevox_core_tmp
            mv voicevox_core_tmp/* voicevox_core
            rm -rf voicevox_core_tmp voicevox_core.zip
          fi

      - name: Install dependencies
        run: npm install

      - name: Build all packages
        run: npm run build

      - name: Typecheck
        run: npm run typecheck
